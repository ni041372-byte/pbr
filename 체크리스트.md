# endpr 프로젝트 개발 현황 체크리스트

이 체크리스트는 `EXECUTION_PLAN.md`, `PROJECT_CONTEXT.md`, `README.md` 파일을 기반으로 `endpr` 프로젝트의 현재 개발 현황과 향후 개발 필요 사항을 점검하기 위해 작성되었습니다.

## 1. 프로젝트 개요 및 원칙 준수 (Project Overview & Principle Adherence)

*   [x] `endpr`의 핵심 목표 (멀티테넌트 헤드리스 CMS)가 코드베이스에 명확히 반영되어 있는가? (확인 완료: `src/middleware.ts`에서 호스트명을 기반으로 테넌트를 식별하고 요청 헤더에 `tenant_id`를 주입하는 로직이 명확히 구현되어 있음. `PENDING_DNS` 상태 처리 및 알 수 없는 호스트명에 대한 `/404` 처리도 존재함.)
*   [x] 방문자용 프론트엔드가 SSG로, 관리자용 백엔드(CMS)가 D1 기반의 동적 앱(CSR/SSR)으로 구현되고 있는가? (확인 완료: `PROJECT_CONTEXT.md`에 명시된 하이브리드 렌더링 전략(`Static for Blogs / Dynamic for CMS Admin`)이 `src/middleware.ts`의 테넌트 식별 로직과 `src/actions/provision.ts`, `src/actions/post.ts`의 Server Action 구현을 통해 잘 반영되어 있음. Server Action은 D1 및 GitHub API와 상호 작용하여 CMS의 동적 백엔드 기능을 제공함.)
*   [x] 콘텐츠의 최종 진실(Source of Truth)이 GitHub Markdown 파일이며, D1이 초안/메타 정보/캐싱 용도로 사용되는 원칙이 지켜지고 있는가? (확인 완료: `src/actions/post.ts`의 `publishPost` 함수는 마크다운 콘텐츠를 GitHub에 직접 커밋하며, D1은 게시물의 상태 관리, 낙관적 락을 위한 버전 정보 저장 등 초안 및 메타 정보 저장 용도로 사용되고 있음을 확인함.)

*   **1.2 절대 원칙 준수 여부**
    *   [x] **격리 (Isolation):** 모든 데이터 쿼리에 `tenant_id`가 누락되지 않도록 강제하는 메커니즘이 구현되어 있는가? (확인 완료: `d1/schema.sql`에서 `tenant_id`가 관련 테이블에 외래 키 또는 `NOT NULL`로 정의되어 있으며, `src/lib/d1.ts`의 `D1Client`가 생성자에서 `tenantId`를 받아 모든 테넌트 관련 쿼리에서 `tenant_id`를 필터링하도록 구현되어 있어 DB 스키마 및 코드 레벨에서 격리가 매우 견고하게 강제되고 있음.)
    *   [x] **엣지 호환성 (Edge Compatibility):** Cloudflare Edge Runtime (Node.js 런타임이 아님)에서 모든 코드가 동작하도록 구현되어 있는가? (`fs` 모듈 사용 금지, `path` 대신 `URL` 조작) (확인 완료: `src` 및 `workers` 디렉토리 내에서 `fs`, `path` 모듈 또는 `process.cwd()`와 같은 Node.js 특정 파일 시스템 API 사용 흔적을 찾지 못함. Cloudflare Pages/Workers 환경에 맞게 개발되었음을 확인.)
    *   [x] **안전한 발행 (Fail-Safe Publishing):** GitHub API 장애 시에도 D1에 '작성 중' 상태가 보존되고 사용자에게 명확한 에러 피드백이 제공되는가? (확인 완료: `src/actions/post.ts`의 `publishPost` 함수에 GitHub API 호출 실패 시 게시물 상태를 `DRAFT` 등으로 롤백하고, 실패 메시지를 반환하며, 배포 로그를 기록하는 로직이 구현되어 있음.)
    *   [x] **고객사 제로 설정 (Zero-Config for Clients):** 고객사가 기술적인 설정 없이 사이트를 운영할 수 있도록 시스템이 설계 및 구현되고 있는가? (부분 완료/설계만 진행: `src/actions/provision.ts`의 `provisionNewTenant` 함수 설명에서 GitHub 리포지토리 생성 및 Cloudflare Custom Hostname 구성을 자동화할 계획을 명시하고 있으나, 실제 구현은 플레이스홀더 상태. 고객에게 DNS 레코드를 전달하는 부분은 여전히 클라이언트의 수동 DNS 설정이 필요함을 암시하여 "제로 설정" 원칙에 완전히 부합하지는 않음.)

## 2. 상세 아키텍처 및 기술 스택 (Architecture Deep Dive)

*   **2.1 프레임워크 및 렌더링**
    *   [x] Next.js 15 (App Router) 기반으로 프로젝트가 구성되어 있는가? (확인 완료: `package.json`에서 Next.js 16.1.1 버전이 사용되고 있음을 확인. Next.js 16은 App Router를 기본으로 사용하므로 요구사항 충족.)
    *   [x] 블로그/방문자 페이지는 SSG로, CMS 관리자 페이지는 동적(CSR/SSR)으로 렌더링되는 하이브리드 전략이 적용되어 있는가? (확인 완료: 이전 "1.1 시스템 정체성 이해 및 반영" 섹션의 두 번째 항목과 동일하며, Next.js Server Actions와 D1 상호 작용을 통해 하이브리드 렌더링 전략이 구현되어 있음을 확인했음.)
    *   [x] Cloudflare Pages 빌드 시스템 (`@cloudflare/next-on-pages`)과의 호환성 및 빌드 안정성 확보되었는가? (구현됨 (설계 및 구성 확인): `wrangler.toml`의 `main` 필드가 Next.js 어댑터에 의해 조정될 예정임을 명시하며, `PROJECT_CONTEXT.md` 및 `README.md`에서 `@cloudflare/next-on-pages` 사용을 언급. 설계 및 구성은 호환성을 확보했으나, 빌드 안정성은 실제 배포를 통해 검증 필요.)

*   **2.2 데이터베이스 (Cloudflare D1)**
    *   [x] `d1/schema.sql`에 정의된 `tenants`, `users`, `posts`, `deployments` 테이블이 정확히 구현되었는가? (확인 완료: `d1/schema.sql` 파일을 검토하여 해당 테이블들이 지정된 컬럼 및 관계로 정의되어 있음을 확인. 특히 `tenant_id`를 통한 격리 원칙이 잘 반영되어 있음.)
    *   [x] `DB` 환경 변수 바인딩을 통해 D1 데이터베이스에 접근하고 있는가? (확인 완료: `src/lib/d1.ts`의 `getD1Binding()` 함수에서 `process.env.DB`를 명시적으로 사용하고 있으며, `wrangler.toml`에 `DB` 바인딩이 정의되어 있음.)
    *   [x] D1을 사용자 인증, 테넌트 설정, 초안 저장, 배포 로그 저장 용도로 활용하고 있는가? (부분 완료: 테넌트 설정, 초안 저장, 배포 로그 저장 용도로는 D1이 활용되고 있으나, 사용자 인증 부분은 `src/lib/auth.ts`가 현재 모의(mock) 상태로 구현되어 D1과의 통합이 필요함.)
    *   [ ] 캐싱 전략 (`unstable_cache`, `revalidateTag`)이 D1 쿼리에 적용되어 있는가?

*   **2.3 스토리지 (Cloudflare R2)**
    *   [ ] `R2_ASSETS` 환경 변수 바인딩을 통해 R2 버킷에 접근하고 있는가?
    *   [ ] R2를 이미지 호스팅에 사용하고 있으며, 퍼블릭 읽기(Custom Domain) 및 인증된 쓰기(Presigned URL)가 구현되었는가?
    *   [ ] `R2_ENDPOINT`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY` 환경 변수가 올바르게 설정되어 있는가?

*   **2.4 인증 (NextAuth.js)**
    *   [ ] NextAuth.js 기반의 인증 시스템이 구현되었는가?
    *   [ ] D1을 백엔드로 사용하는 커스텀 어댑터가 구현되어 있는가?

*   **2.5 개발/배포 환경**
    *   [ ] GitHub (Tenant Repos & CMS Repo)를 소스 코드로 사용하고 있는가?
    *   [ ] Cloudflare Pages Build System을 CI/CD에 활용하고 있는가?

## 3. 핵심 기능 구현 현황 (Core Feature Implementation Status)

*   **3.1 사이트 프로비저닝 워크플로우**
    *   [ ] 슈퍼 어드민이 신규 사이트를 생성하는 UI 및 백엔드 로직이 구현되었는가?
    *   [ ] GitHub API를 사용하여 템플릿 레포지토리를 복제하고 `site-config.json`을 수정하는 기능이 구현되었는가?
    *   [ ] Cloudflare API를 호출하여 커스텀 호스트명 등록 및 TXT 레코드를 발급하는 기능이 구현되었는가?
    *   [ ] D1 `tenants` 테이블에 레코드를 삽입하고, 초기 `status`를 `PENDING_DNS`로 설정하는 로직이 구현되었는가?

*   **3.2 CMS 에디터 및 이미지 파이프라인**
    *   [ ] CMS 에디터에서 이미지 드래그 앤 드롭 기능이 구현되었는가?
    *   [ ] 클라이언트가 `/api/upload/presigned` 엔드포인트를 통해 R2 업로드용 Presigned URL을 요청하는 기능이 구현되었는가?
    *   [ ] 서버(Worker)에서 `tenant_id`를 검증하고 R2 `PutObjectCommand`를 사용하여 Presigned URL을 생성하는 로직이 구현되었는가?
    *   [ ] 클라이언트가 발급받은 Presigned URL로 직접 R2에 이미지를 업로드하는 기능이 구현되었는가?
    *   [ ] 이미지 업로드 성공 시 마크다운 본문에 이미지 URL(`![alt](https://assets.endpr.io/.../image.webp)`)이 올바르게 삽입되는가?

*   **3.3 발행 시스템 (Publishing Engine)**
    *   [ ] 'Publish' 버튼 클릭 시 필수 필드(제목, 슬러그 등) 검증 로직이 동작하는가?
    *   [ ] D1 `posts` 테이블의 `status`가 `PUBLISHING` -> `PUBLISHED`로 올바르게 변경되는가?
    *   [ ] Frontmatter (JSON)와 본문 (Markdown)을 결합하여 `--- 
 {json} 
 --- 
 {markdown}` 형식의 마크다운 파일을 생성하는 기능이 구현되었는가?
    *   [ ] GitHub API (`createOrUpdateFileContents`)를 호출하여 `content/posts/{slug}.mdx` 경로에 파일을 커밋하는 기능이 구현되었는가?
    *   [ ] Cloudflare Pages의 Deploy Hook을 트리거하거나 자동 감지되도록 설정되어 있는가?
    *   [ ] 발행 완료 후 D1 `deployments` 테이블에 배포 로그가 정확히 기록되는가?

## 4. 엣지 케이스 및 에러 핸들링 (Edge Cases & Error Handling)

*   **4.1 GitHub API Rate Limit 처리**
    *   [ ] 동시에 대량의 발행 요청 발생 시 Cloudflare Queues를 도입하여 요청을 큐에 적재하고 스로틀링하는 메커니즘이 설계 또는 구현되었는가?

*   **4.2 도메인 연결 지연 처리**
    *   [ ] 고객 도메인 연결 지연(DNS 설정 미비 등) 시 CMS 대시보드에 "도메인 연결 대기 중" 배너가 표시되는가?
    *   [ ] 주기적으로(Cron Trigger) Cloudflare API를 통해 도메인 상태를 확인하고 D1 `tenants` 테이블을 업데이트하는 로직이 구현되었는가?

*   **4.3 데이터 충돌 (동시성) 처리**
    *   [ ] 사용자 A와 B가 동시에 같은 글을 수정할 경우를 대비하여 `posts` 테이블에 `version` 컬럼을 이용한 낙관적 락(Optimistic Locking)이 적용되었는가?
    *   [ ] 충돌 발생 시 사용자에게 "다른 사용자가 수정 중입니다"와 같은 명확한 알림이 제공되는가?

## 5. 개발 가이드라인 준수 및 환경 설정 (Development Guidelines & Environment Setup)

*   **5.1 엄격한 타입 지정 (Strict Typing)**
    *   [ ] 모든 데이터 입출력(API 요청/응답, DB 스키마)에 Zod 스키마를 사용하여 유효성 검사 및 타입 안전성을 확보하고 있는가?

*   **5.2 배포 환경 설정**
    *   [ ] Cloudflare Pages 배포 시 `DB`, `R2_ASSETS` 바인딩이 올바르게 설정되었는가?
    *   [ ] `GITHUB_TOKEN`, `R2_ENDPOINT`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY` 환경 변수(비밀 값)가 안전하게 설정되었는가?
    *   [ ] `d1/schema.sql`을 이용한 D1 스키마 마이그레이션이 배포 후 정상적으로 이루어지는지 확인되었는가?
    *   [ ] 초기 데이터 시딩(테넌트, 슈퍼 어드민 사용자) 가이드 또는 스크립트가 명확하게 제공되는가?

*   **5.3 로컬 개발 환경**
    *   [ ] `npm install` 및 `npx wrangler d1 execute ... --local` 명령을 통해 로컬 D1 설정이 원활하게 이루어지는가?
    *   [ ] `npx wrangler dev --local --experimental-local-pages` 명령과 필요한 환경 변수 설정을 통해 로컬 개발 서버가 정상적으로 동작하는가?

---

**제언 사항:**

*   **테스트 커버리지 강화:** 주요 기능(프로비저닝, 발행, 이미지 업로드)에 대한 단위 및 통합 테스트 코드 추가를 통해 시스템의 안정성을 확보해야 합니다. 특히 멀티테넌트 격리 원칙이 잘 지켜지는지 검증하는 테스트가 중요합니다.
*   **보안 강화:** `GITHUB_TOKEN`과 같은 민감 정보는 환경 변수를 통해 안전하게 관리되어야 하며, API 엔드포인트에 대한 적절한 인증 및 권한 부여(RBAC) 로직이 견고하게 구현되어야 합니다. 특히 Presigned URL 발급 시 `tenant_id` 검증 로직은 매우 중요합니다.
*   **성능 모니터링 및 최적화:** Cloudflare Workers 및 D1, R2 사용량에 대한 모니터링 시스템을 구축하고, 잠재적인 성능 병목 지점을 미리 파악하여 최적화할 필요가 있습니다.
*   **관리자 대시보드 UI/UX 개선:** CMS 관리자 대시보드의 사용자 경험(UX)을 지속적으로 개선하여 고객사(Tenant)와 슈퍼 어드민이 효율적으로 작업을 수행할 수 있도록 해야 합니다. 특히 도메인 연결 지연 시의 피드백 UI 등은 사용자 친화적으로 구현되어야 합니다.
*   **GitHub Webhook 연동:** GitHub 리포지토리의 변경 사항을 실시간으로 감지하고 D1에 반영하거나 빌드를 트리거하는 GitHub Webhook 연동을 고려해볼 수 있습니다. 이를 통해 발행 시스템의 반응성을 더욱 높일 수 있습니다.
*   **확장성 고려:** 향후 추가될 기능(예: 커스텀 테마, 플러그인)을 고려하여 시스템 아키텍처가 확장성을 가질 수 있도록 설계되었는지 주기적으로 검토해야 합니다.
