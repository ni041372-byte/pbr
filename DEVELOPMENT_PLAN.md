# endpr 개발 계획서 (Development Plan)

이 문서는 `체크리스트.md`의 분석 결과를 바탕으로, 프로젝트를 완성하기 위한 구체적인 개발 계획을 단계별 체크리스트 형식으로 정의합니다.

---

### **Phase 1: 기반 다지기 (인증 및 핵심 CMS 기능)**
가장 시급한 모의(mock) 구현을 실제 기능으로 대체하고, 기본적인 콘텐츠 관리가 가능하도록 만드는 데 집중합니다.

-   [x] **사용자 인증 시스템 구현 (NextAuth.js)**
    -   [x] `next-auth` 패키지를 설치하고, 관련 API 라우트(`src/app/api/auth/[...nextauth]/route.ts`)를 설정합니다.
    -   [x] `src/lib/auth.ts`의 모의 인증 로직을 실제 NextAuth.js 설정으로 교체합니다.
    -   [x] Cloudflare D1 데이터베이스를 사용하기 위한 커스텀 `NextAuth.js` 어댑터를 구현합니다. (주: 현재는 핵심 기능만 구현된 플레이스홀더 상태)
    -   [x] 로그인/로그아웃 기능을 수행할 수 있는 최소한의 UI를 구현합니다.
-   [x] **기본 게시물 관리 UI 구현**
    -   [x] 게시물 목록을 조회하고, '새 글 작성' 버튼을 제공하는 페이지를 생성합니다.
    -   [x] 제목, 슬러그, 마크다운 본문을 입력할 수 있는 게시물 작성/수정 페이지를 구현합니다.
    -   [x] '저장' 버튼 클릭 시 `createPost` 또는 `updatePost` 서버 액션을 호출하도록 연동합니다.
    -   [x] '발행' 버튼 클릭 시 `publishPost` 서버 액션을 호출하고, API로부터 반환된 성공 또는 실패 메시지(동시성 충돌 메시지 포함)를 사용자에게 명확히 표시합니다.

### **Phase 2: 핵심 SaaS 워크플로우 (사이트 프로비저닝 및 이미지 관리)**
신규 고객을 유치하고, CMS의 핵심 기능인 이미지 콘텐츠를 관리할 수 있는 기능을 구현합니다.

-   [x] **이미지 업로드 파이프라인 구축 (Cloudflare R2)** (주: `R2_BUCKET_NAME`, `R2_PUBLIC_URL` 환경변수 설정 필요)
    -   [x] R2 업로드를 위한 Presigned URL을 생성하는 API 라우트(또는 Worker)를 구현합니다. (`tenant_id` 검증 포함)
    -   [x] 게시물 수정 페이지에 마크다운 에디터와 '이미지 업로드' 기능을 추가합니다.
    -   [x] 이미지 업로드 시, 위 API를 호출하여 Presigned URL을 받아오고, 해당 URL로 직접 파일을 R2에 업로드하는 클라이언트 로직을 구현합니다.
    -   [x] 업로드 성공 시, 반환된 이미지의 최종 URL을 마크다운 본문에 삽입합니다.
-   [x] **사이트 프로비저닝 백엔드 구현**
    -   [x] `src/actions/provision.ts`의 플레이스홀더 로직을 실제 기능으로 구현합니다.
    -   [x] GitHub API를 호출하여 템플릿 리포지토리를 복제하는 기능을 구현합니다.
    -   [x] Cloudflare API를 호출하여 신규 Custom Hostname을 등록하고, 인증용 TXT 레코드를 받아오는 기능을 구현합니다. (주: 관련 Cloudflare API 호출은 도구 부재로 플레이스홀더 처리됨)
    -   [x] 위 두 작업 성공 시, D1의 `tenants` 테이블에 `status: 'PENDING_DNS'`로 신규 테넌트 정보를 삽입합니다.
-   [x] **슈퍼 어드민용 프로비저닝 UI 구현**
    -   [x] 신규 고객의 이름, 희망 도메인 등을 입력받아 `provisionNewTenant` 액션을 호출하는 관리자 페이지를 구현합니다.
    -   [x] 액션 실행 후, 고객이 자신의 도메인에 설정해야 할 TXT 레코드 정보를 명확히 표시해줍니다.

### **Phase 3: 안정성 및 성능 강화 (Robustness & Performance)**
애플리케이션을 상용 수준으로 안정화시키고, 사용자가 쾌적한 경험을 할 수 있도록 성능을 개선합니다.

-   [x] **D1 쿼리 캐싱 적용**
    -   [x] 자주 조회하지만 내용이 자주 바뀌지 않는 데이터(게시물 목록, 테넌트 설정 등)를 조회하는 D1 쿼리에 Next.js의 `unstable_cache`를 적용합니다.
    -   [x] 데이터가 변경되는 시점(예: 게시물 발행, 설정 수정)에 `revalidateTag`를 호출하여 캐시를 무효화하는 로직을 추가합니다.
-   [ ] **GitHub API Rate Limit 처리 (Cloudflare Queues)** (보류: 현 `@cloudflare/next-on-pages` 아키텍처에서는 Queue Consumer 구현이 복잡하여 아키텍처 변경 전까지 보류)
    -   [ ] `wrangler.toml`에 Cloudflare Queue를 바인딩하고, 큐 메시지를 처리할 Consumer Worker를 생성합니다.
    -   [ ] `publishPost` 액션이 GitHub API를 직접 호출하는 대신, 발행할 게시물 정보를 담은 메시지를 큐에 보내도록 수정합니다.
    -   [ ] Consumer Worker가 큐의 메시지를 받아 GitHub API 호출을 순차적으로 처리하도록 구현합니다.
-   [x] **도메인 연결 지연 처리 기능 구현**
    -   [x] 테넌트의 `status`가 `PENDING_DNS`일 경우, CMS 대시보드에 "도메인 연결 대기 중"과 같은 안내 배너를 표시하는 UI 로직을 추가합니다.
    -   [ ] `wrangler.toml`에 Cron Trigger를 설정하여, 주기적으로 도메인 상태를 확인하고 D1의 `tenants` 테이블을 업데이트하는 Worker를 구현합니다. (보류: 현 `@cloudflare/next-on-pages` 아키텍처에서는 Cron Worker 구현이 복잡하여 아키텍처 변경 전까지 보류)

### **Phase 4: 마무리 및 개선 (Final Touches & Polish)**
기능 구현의 완성도를 높이고, 사용자 경험을 개선하며, 테스트를 보강합니다.

-   [x] **발행 시스템 완성도 향상**
    -   [x] `publishPost` 액션에 제목, 슬러그 등 필수 필드가 비어있는지 검증하는 로직을 추가합니다.
    -   [x] GitHub 파일 생성 API의 응답에서 실제 커밋 SHA를 받아와 `deployments` 로그에 기록하도록 수정합니다.
-   [x] **관리자 대시보드 UI/UX 개선**
    -   [x] 전반적인 관리자 페이지의 디자인과 사용자 경험을 검토하고 개선합니다. (1차 개선 완료: 테이블 레이아웃 적용)
-   [ ] **테스트 커버리지 강화** (보류: 테스트 프레임워크 설정 및 CI 연동 필요)
    -   [ ] 새로 구현된 주요 기능(인증, 프로비저닝, 이미지 업로드 등)에 대한 단위 및 통합 테스트를 추가합니다.
